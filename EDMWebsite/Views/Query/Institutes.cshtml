@model EDMWebsite.Models.ViewModels.QueryModel
@{
    ViewBag.Title = "行政办公建筑";
    Layout = "~/Views/Shared/_AceLayout.cshtml";
    var selector = ViewData["Institutes"] as List<EDMWebsite.Models.DbModels.Comdict>;
    }
    @section Styles {

        @*<link href="~/Content/ace_admin1.3.1/assets/css/select2.css" rel="stylesheet" />*@
        <link href="~/Content/ace_admin1.3.1/assets/css/datepicker.css" rel="stylesheet" />
        @*<link href="~/Content/matrix/css/datepicker.css" rel="stylesheet" />*@
        <link href="~/Content/zTree/css/zTreeStyle/zTreeStyle.css" rel="stylesheet" />
    }

    <div class="row">
        <div class="col-sm-12">
            <div class="row">

            </div>
            <div class="row">
                <div class="col-sm-12">
                    @*<div class="widget-box">

                        <div class="widget-body" style="padding:10px;">
                            <div class="widget-main" style="padding:10px;">*@

                    @using (Html.BeginForm("Institutes", "Query", FormMethod.Post, new { @class = "form-horizontal", style = "padding-top:10px;" }))
                    {
                        @Html.HiddenFor(model => model.ActiveTabId);
                        @*@Html.HiddenFor(model => model.RoomCodes)*@


                    <div class="row " style="margin-bottom:20px">
                        <div class="col-sm-offset-3 col-sm-6">
                            @Html.ListBoxFor(model => model.Rooms, (List<SelectListItem>)ViewData["Institutes"], new { @class = "chosen-select tag-input-style", multiple = "" })
                        </div>
                    </div>

                        <div class="row">
                            <div id="smartSearch">
                                <div class="form-group">
                                    <label for="startDate" class="col-sm-1 control-label no-padding-right">开始日期</label>
                                    <div class="col-sm-2">
                                        @Html.TextBoxFor(model => model.StartDate, new { @class = "col-xs-12 col-sm-12 datetimepicker", id = "startDate" })
                                    </div>
                                    <label for="startDate" class="col-sm-1 control-label no-padding-right">结束日期</label>
                                    <div class="col-sm-2">
                                        @Html.TextBoxFor(model => model.EndDate, new { @class = "col-xs-12 col-sm-12 datetimepicker", id = "endDate" })
                                    </div>
                                    <label for="startDate" class="col-sm-1 control-label no-padding-right">类型</label>
                                    <div class="col-sm-2">
                                        @Html.TextBoxFor(model => model.EnergyType, new { @class = "col-xs-12 col-sm-12 tag-input-style", multiple = "", onfocus = "$('#modal-form').modal('toggle')" })
                                        @Html.HiddenFor(model => model.EnergyTypeCodes)
                                    </div>
                                    <div class="col-sm-3">
                                        <button type="submit" class="btn btn-primary btn-sm" id="simple-query-btn">查询</button>
                                        <a href="#" id="advancedQuery">高级搜索选项 <i class="ace-icon fa fa-chevron-down" style="font-size: 10px;"></i></a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div id="advancedQueryDiv" style="">
                                @*<hr />*@
                                <div class="form-group">

                                    <label for="statisticDensity" class="col-sm-1 control-label no-padding-right">统计密度</label>
                                    <div class="col-sm-2">
                                        @Html.EnumDropDownListFor(model => model.StatisticWay, new { @class = "col-xs-12 col-sm-12" })

                                        @*<select class="col-xs-12 col-sm-12 " id="statisticDensity">
                                                <option>逐时能耗</option>
                                                <option>逐日能耗</option>
                                                <option>逐月能耗</option>
                                            </select>*@
                                    </div>
                                    @*<label for="statisticMethod" class="col-sm-1 control-label no-padding-right">统计类型</label>
                                        <div class="col-sm-2">
                                            <select class="col-xs-12 col-sm-12" id="statisticMethod">
                                                <option value="0">能耗项求和统计</option>
                                                <option value="1">能耗项对比统计</option>
                                            </select>
                                            @{
                                                                   var a = new List<SelectListItem>();
                                                                   a.Add(new SelectListItem() { Text = "能耗项求和统计", Value = "0" });
                                                                   a.Add(new SelectListItem() { Text = "能耗项对比统计", Value = "1" });
                                            }

                                        </div>*@
                                    <div class="col-sm-3">
                                    </div>
                                    <div class="col-md-3">  </div>
                                </div>
                            </div>
                        </div>

                    }
                </div>
            </div>
            <div class="row">
                <ul class="nav nav-tabs">
                    <li><a data-toggle="tab" href="#tab1"><i class="blue ace-icon fa fa-calendar bigger-120"></i> 表格</a></li>
                    <li class="active"><a data-toggle="tab" href="#tab2"><i class="light-red ace-icon fa fa-bar-chart-o bigger-120"></i> 图形</a></li>
                    @*<li><a data-toggle="tab" href="#tab3">Tab3</a></li>*@
                </ul>

                <div class="tab-content no-padding">
                    <div id="tab1" class="tab-pane">
                        @if (Model.StatisticWay == EDMWebsite.Models.ViewModels.StatisticWay.逐时能耗)
                        {
                            @Html.Partial("_HourResultPartial", Model.HourResult)
                        }
                        else if (Model.StatisticWay == EDMWebsite.Models.ViewModels.StatisticWay.逐日能耗)
                        {
                            @Html.Partial("_DayResultPartial", Model.DayResult)
                        }
                        else if (Model.StatisticWay == EDMWebsite.Models.ViewModels.StatisticWay.逐月能耗)
                        {
                            @Html.Partial("_MonthResultPartial", Model.MonthResult)
                        }

                    </div>
                    <div id="tab2" class="tab-pane active">
                        <div class="row">
                            <div class="btn-group col-xs-12">
                                <button type="button" id="btn-column" class="btn btn-white btn-sm btn-primary">柱状图</button>
                                <button type="button" id="btn-line" class="btn btn-white btn-sm btn-primary">线形图</button>
                                <button type="button" id="btn-pie" class="btn btn-white btn-sm btn-primary">饼状图</button>
                            </div>
                        </div>
                        <div class="row">
                            <div id="chartContainer" class="text-center col-xs-12">
                                <!-- chart container-->
                            </div>

                        </div>

                    </div>
                    <div id="tab3" class="tab-pane ">

                        <table class="table table-striped table-bordered table-hover">
                            <thead>
                                <tr onclick="alert('aaaa')">
                                    <th class="text-center">时间</th>
                                    <th class="text-center">能耗值</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model != null && Model.Result != null)
                                {
                                    foreach (KeyValuePair<string, string> item in Model.Result)
                                    {
                                        <tr class="gradeU">
                                            <td class="text-right">@item.Key</td>
                                            <td class="center">@item.Value</td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>

                    </div>

                </div>

            </div>

        </div>
    </div>

    <div id="modal-form" class="modal fade" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="blue bigger">选择能耗类型</h4>
                </div>

                <div class="modal-body">
                    <div class="row">
                        <div class="col-xs-12 col-sm-12">
                            <ul id="treeDemo" class="ztree"></ul>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-sm" data-dismiss="modal" id="modal-cancle">
                        <i class="ace-icon fa fa-times"></i>
                        取消
                    </button>

                    <button class="btn btn-sm btn-primary" id="modal-ok">
                        <i class="ace-icon fa fa-check"></i>
                        确认
                    </button>
                </div>
            </div>
        </div>
    </div><!-- PAGE CONTENT ENDS -->

    <div id="modal-form-room" class="modal fade" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="blue bigger">选择房间</h4>
                </div>

                <div class="modal-body">
                    <div class="row">
                        <div class="col-xs-12 col-sm-12">
                            <ul id="treeRooms" class="ztree"></ul>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-sm" data-dismiss="modal" id="modal-cancle">
                        <i class="ace-icon fa fa-times"></i>
                        取消
                    </button>

                    <button class="btn btn-sm btn-primary" id="modal-room-ok">
                        <i class="ace-icon fa fa-check"></i>
                        确认
                    </button>
                </div>
            </div>
        </div>
    </div><!-- PAGE CONTENT ENDS -->
    @*<div class=".hidden-phone" style="position:fixed;top:100px;right:20px;">
            <button class="btn btn-warning" id="compareBtn">对比</button>

        </div>*@


    @section Scripts {
        <script src="~/Content/ace_admin1.3.1/assets/js/date-time/moment/min/moment.min.js"></script>
        <script src="~/Content/ace_admin1.3.1/assets/js/date-time/moment/min/moment-with-locales.min.js"></script>
        <script src="~/content/ace_admin1.3.1/assets/js/date-time/locales/moment-local-zhcn.js"></script>
        <script src="~/Content/ace_admin1.3.1/assets/js/date-time/moment/bootstrap-datetimepicker.min.js"></script>
        <script src="~/Content/zTree/js/jquery.ztree.all-3.5.min.js"></script>

        <script src="~/Content/highchart/highcharts.src.js"></script>
        <script src="~/Content/highchart/drilldown.src.js"></script>
        <script src="~/Content/highchart/HighchartsConfig.js"></script>

        <script type="text/javascript">
            $(function () {

                var activedTabId = $("#ActiveTabId").val();
                $(".nav.nav-tabs > li >a").each(function (index,element) {
                    if ($(element).attr("href") =="#"+activedTabId) {
                        $(element).click();
                    }
                });


                $(".nav.nav-tabs > li >a").click(function () {
                    var id = $(this).attr("href");
                    $("#ActiveTabId").val( id.slice(1,id.length));
                });


                var setting = {
                    check: {
                        enable: true,
                        chkboxType: {
                            "Y":"", "N":""
                        }
                    },
                    data: {
                        simpleData: {
                            enable: true
                        }
                    }
                };

                var zNodes =@Html.Raw(ViewData["TypeNodes"]) ;
                zTreeObj = $.fn.zTree.init($("#treeDemo"), setting, zNodes);
                $("#modal-ok").click(function () {
                    //var nodes = zTreeObj.selectNode();
                    var checkedNodes = zTreeObj.getCheckedNodes(true);
                    //$.each()
                    var ids = "";
                    var names = "";
                    for (var i = 0; i < checkedNodes.length; i++) {
                        ids+=checkedNodes[i].id+",";
                        names+=checkedNodes[i].name+",";
                    }

                    //checkedNodes.each(function (index,element) {
                    //    ids+=element.id+",";
                    //});
                    //alert(ids);
                    $("#EnergyTypeCodes").val(ids);
                    $("#EnergyType").val(names);


                    $('#modal-form').modal('toggle');

                })

                var roomzNodes =@Html.Raw(ViewData["BuildingNodes"]) ;
                roomzTreeObj = $.fn.zTree.init($("#treeRooms"), setting, roomzNodes);
                $("#modal-room-ok").click(function () {
                    //var nodes = zTreeObj.selectNode();
                    var checkedNodes = roomzTreeObj.getCheckedNodes(true);
                    //$.each()
                    var ids = "";
                    var names = "";
                    for (var i = 0; i < checkedNodes.length; i++) {
                        ids+=checkedNodes[i].id+",";
                        names+=checkedNodes[i].name+",";
                    }

                    //checkedNodes.each(function (index,element) {
                    //    ids+=element.id+",";
                    //});
                    //alert(ids);
                    $("#RoomCodes").val(ids);
                    $("#Rooms").val(names);


                    $('#modal-form-room').modal('toggle');

                })

                $("#advancedQuery").click(function () {
                    $("#advancedQueryDiv").slideToggle();
                    //$("#simple-query-btn").fadeToggle();
                    if ($("#advancedQuery").html().indexOf("高级搜索选项")!=-1) {
                        $("#advancedQuery").html("智能搜索选项 <i class='ace-icon fa fa-chevron-up' style='font-size: 10px;'></i>");
                    } else {
                        $("#advancedQuery").html("高级搜索选项<i class='ace-icon fa fa-chevron-down' style='font-size: 10px;'></i>");
                    }

                });

                var series = @Html.Raw(Model.ChartSeries);

                refreshChart('chartContainer','column',series,"@Model.StatisticWay.ToString()");

                $("#btn-pie").click(function () {
                    if (series.length>0) {
                        for (var i = 0; i < series.length; i++) {
                            series[i].colorByPoint=true;
                        }
                    }

                    refreshChart('chartContainer','pie',series,"@Model.StatisticWay.ToString()");
                });
                $("#btn-line").click(function () {
                    if (series.length>0) {
                        for (var i = 0; i < series.length; i++) {
                            series[i].colorByPoint=false;
                        }
                    }
                    refreshChart('chartContainer','line',series,"@Model.StatisticWay.ToString()");
                });
                $("#btn-column").click(function () {
                    if (series.length>0) {
                        for (var i = 0; i < series.length; i++) {
                            series[i].colorByPoint=false;
                        }
                    }
                    refreshChart('chartContainer','column',series,"@Model.StatisticWay.ToString()");
                });



                $("#compareBtn").popover({
                    trigger: 'click',
                    placement: 'left',
                    html: 'true',
                    title: "title",
                    content: 'aaaaaa',
                    template: '<div class="popover" style="z-index:1000;"><div class="arrow"></div>' +
                              '<h3 class="popover-title"></h3><div class="popover-content">' +
                              '</div><div class="popover-footer"><button type="button" class="btn btn-primary popover-submit">' +
                              '<i class="icon-ok icon-white"></i></button>&nbsp;' +
                              '<button type="button" class="btn btn-default popover-cancel">' +
                              '<i class="icon-remove"></i></button></div></div>'
                });

                //$("#startDate").datetimepicker();
                $('.datetimepicker').datetimepicker({
                    format:"YYYY-MM-DD HH:mm"
                }).next().on(ace.click_event, function(){
                    $(this).prev().focus();
                });
            });


        </script>
    }